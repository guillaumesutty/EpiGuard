<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EpiGuard â€” Methylation Defense</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Crimson+Pro:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#f2f6fc; --panel:#fff; --border:#dde4ee;
    --accent:#1a7aff; --danger:#e02040; --warn:#e07010;
    --methyl:#8b22d4; --methyl-light:#c47ef5; --methyl-pale:#f3e8ff;
    --text:#1a2540; --dim:#7a90b0; --success:#18a060;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Space Mono',monospace;height:100vh;overflow:hidden;display:flex;flex-direction:column;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(26,122,255,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(26,122,255,.04) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;}

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 24px;border-bottom:1px solid var(--border);background:var(--panel);box-shadow:0 2px 8px rgba(26,37,64,.07);position:relative;z-index:10;flex-shrink:0;}
  .logo{font-family:'Crimson Pro',serif;font-size:1.4rem;font-style:italic;font-weight:300;color:var(--methyl);letter-spacing:.03em;}
  .logo span{color:var(--text);font-style:normal;font-weight:600;}
  .hud{display:flex;gap:24px;align-items:center;}
  .stat{display:flex;flex-direction:column;align-items:center;gap:1px;}
  .stat-label{font-size:.5rem;color:var(--dim);letter-spacing:.15em;text-transform:uppercase;}
  .stat-val{font-size:1.05rem;font-weight:700;}
  #score-val{color:var(--methyl);}
  #level-val{color:var(--warn);}
  .brains-wrap{display:flex;flex-direction:column;align-items:center;gap:3px;}
  .brains-row{display:flex;gap:4px;align-items:center;}
  .brain-icon{font-size:1.4rem;line-height:1;transition:filter .3s,transform .3s;display:inline-block;}
  .brain-icon.lost{filter:grayscale(1) opacity(.22);transform:scale(.78);}
  .brain-icon.shake{animation:brainShake .4s ease;}
  .brain-icon.gain{animation:brainGain .5s ease;}
  @keyframes brainShake{0%,100%{transform:translateX(0) rotate(0)}20%{transform:translateX(-5px) rotate(-10deg)}60%{transform:translateX(5px) rotate(10deg)}80%{transform:translateX(-3px) rotate(-5deg)}}
  @keyframes brainGain{0%{transform:scale(.7);filter:brightness(2)}60%{transform:scale(1.25)}100%{transform:scale(1)}}
  .miss-counter{display:flex;flex-direction:column;align-items:center;gap:2px;}
  .miss-pips{display:flex;gap:3px;}
  .miss-pip{width:10px;height:10px;border-radius:50%;background:var(--border);border:1.5px solid #ccd4e0;transition:background .25s,transform .2s;}
  .miss-pip.filled{background:var(--danger);border-color:var(--danger);transform:scale(1.1);}
  .slow-badge{display:none;align-items:center;gap:5px;padding:4px 10px;background:#e8f8ff;border:1px solid #0090c8;border-radius:20px;font-size:.56rem;color:#0090c8;font-weight:700;animation:badgePulse 1s ease infinite;}
  .slow-badge.active{display:flex;}
  @keyframes badgePulse{0%,100%{opacity:1}50%{opacity:.55}}

  /* â”€â”€â”€ MAIN LAYOUT â”€â”€â”€ */
  main{flex:1;display:flex;overflow:hidden;min-height:0;}
  .side-panel{width:160px;min-width:160px;border-right:1px solid var(--border);padding:14px 12px;display:flex;flex-direction:column;gap:9px;background:var(--panel);overflow-y:auto;}
  .panel-title{font-size:.53rem;color:var(--dim);letter-spacing:.2em;text-transform:uppercase;text-align:center;}
  .methyl-status{background:var(--methyl-pale);border:1.5px solid var(--methyl-light);border-radius:10px;padding:9px;text-align:center;}
  .methyl-status .ms-label{font-size:.5rem;color:var(--methyl);letter-spacing:.12em;text-transform:uppercase;margin-bottom:3px;}
  .methyl-status .ms-val{font-size:1.6rem;font-weight:700;color:var(--methyl);line-height:1;}
  .methyl-status .ms-sub{font-size:.5rem;color:var(--methyl-light);margin-top:2px;}
  .separator{height:1px;background:var(--border);}
  .marks-count{text-align:center;font-size:.6rem;color:var(--dim);line-height:2;}
  .marks-count .ok{color:var(--success);font-weight:700;}
  .marks-count .bad{color:var(--danger);font-weight:700;}
  .legend-title{font-size:.5rem;color:var(--dim);letter-spacing:.18em;text-transform:uppercase;text-align:center;margin-bottom:3px;}
  .legend-item{display:flex;align-items:center;gap:6px;font-size:.53rem;color:var(--dim);margin-bottom:4px;line-height:1.3;}
  .legend-emoji{font-size:.95rem;flex-shrink:0;}

  /* â”€â”€â”€ GAME AREA â”€â”€â”€ */
  .game-area{flex:1;position:relative;overflow:hidden;display:flex;}
  #chromatin-canvas{width:100%;height:100%;cursor:pointer;display:block;}
  #items-layer{position:absolute;inset:0;pointer-events:none;overflow:hidden;}

  /* FALLING ITEMS â€” big & cute */
  .falling-item{
    position:absolute;font-size:3rem;line-height:1;
    cursor:pointer;pointer-events:all;user-select:none;
    filter:drop-shadow(0 4px 8px rgba(0,0,0,.18));
    transition:transform .1s;
    display:flex;flex-direction:column;align-items:center;gap:2px;
  }
  .falling-item:hover{transform:scale(1.22) !important;}
  .falling-item.bonus{animation:cuteBounce 1.8s ease infinite;}
  .falling-item.danger-item{animation:dangerWiggle 1.2s ease infinite;}
  @keyframes cuteBounce{0%,100%{transform:translateY(0) rotate(-4deg)}50%{transform:translateY(-6px) rotate(4deg)}}
  @keyframes dangerWiggle{0%,100%{transform:rotate(-6deg)}50%{transform:rotate(6deg)}}
  .item-label{
    font-size:.55rem;font-family:'Space Mono',monospace;font-weight:700;
    padding:2px 8px;border-radius:12px;white-space:nowrap;
    pointer-events:none;margin-top:1px;
  }
  .item-label.good{background:#dcfce7;color:#166534;border:1px solid #86efac;}
  .item-label.bad{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;}
  .item-label.therapy{background:#f3e8ff;color:#6b21a8;border:1px solid #c084fc;}

  /* â”€â”€â”€ RIGHT PANEL â”€â”€â”€ */
  .events-panel{width:205px;min-width:205px;border-left:1px solid var(--border);padding:14px 10px;display:flex;flex-direction:column;gap:7px;background:var(--panel);overflow:hidden;}
  .events-title{font-size:.53rem;color:var(--dim);letter-spacing:.2em;text-transform:uppercase;text-align:center;}
  .events-log{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:4px;}
  .events-log::-webkit-scrollbar{width:3px;}
  .events-log::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
  .event-item{padding:5px 8px;border-radius:6px;font-size:.59rem;line-height:1.5;border-left:3px solid var(--border);animation:slideIn .22s ease;background:var(--bg);}
  .event-item.loss{border-color:var(--danger);color:var(--danger);background:#fff2f4;}
  .event-item.gain{border-color:var(--success);color:var(--success);background:#f0fdf6;}
  .event-item.warn{border-color:var(--warn);color:var(--warn);background:#fff8f0;}
  .event-item.info{border-color:var(--border);color:var(--dim);}
  @keyframes slideIn{from{opacity:0;transform:translateX(12px)}to{opacity:1;transform:translateX(0)}}
  .tumour-meter{margin-top:4px;}
  .tumour-label{font-size:.53rem;color:var(--dim);letter-spacing:.07em;text-transform:uppercase;margin-bottom:4px;display:flex;justify-content:space-between;}
  .tumour-label span{color:var(--danger);font-weight:700;}
  .tumour-bar{height:8px;background:var(--border);border-radius:4px;overflow:hidden;}
  .tumour-fill{height:100%;background:linear-gradient(90deg,#ff8060,#e02040);border-radius:4px;transition:width .5s ease;}

  /* â”€â”€â”€ OVERLAYS â”€â”€â”€ */
  .overlay{position:fixed;inset:0;background:rgba(240,245,252,.93);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(8px);}
  .overlay.hidden{display:none;}

  /* NARRATIVE SCREEN */
  .narrative-modal{background:var(--panel);border:1px solid var(--border);border-radius:24px;padding:44px 48px;max-width:660px;width:94%;box-shadow:0 20px 70px rgba(26,37,64,.15);position:relative;max-height:90vh;overflow-y:auto;}
  .narrative-modal::-webkit-scrollbar{width:4px;}
  .narrative-modal::-webkit-scrollbar-thumb{background:var(--methyl-light);border-radius:2px;}
  .narr-header{display:flex;align-items:center;gap:16px;margin-bottom:22px;}
  .narr-logo{font-size:3rem;line-height:1;}
  .narr-title{font-family:'Crimson Pro',serif;font-size:2.2rem;font-style:italic;font-weight:300;color:var(--methyl);line-height:1.2;}
  .narr-title span{display:block;font-size:1rem;font-style:normal;color:var(--dim);font-family:'Space Mono',monospace;margin-top:4px;}
  .narr-slides{}
  .narr-slide{display:none;animation:fadeSlide .4s ease;}
  .narr-slide.active{display:block;}
  @keyframes fadeSlide{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .slide-tag{display:inline-block;font-size:.55rem;letter-spacing:.18em;text-transform:uppercase;font-weight:700;padding:3px 10px;border-radius:20px;margin-bottom:12px;}
  .slide-tag.science{background:var(--methyl-pale);color:var(--methyl);}
  .slide-tag.program{background:#e8f8ff;color:#0060aa;}
  .slide-tag.mission{background:#f0fdf6;color:var(--success);}
  .slide-tag.game{background:#fff8f0;color:var(--warn);}
  .narr-slide h2{font-family:'Crimson Pro',serif;font-size:1.6rem;font-style:italic;color:var(--text);margin-bottom:10px;line-height:1.3;}
  .narr-slide p{font-size:.75rem;color:var(--dim);line-height:2;margin-bottom:10px;}
  .narr-slide p strong{color:var(--text);}
  .highlight-box{background:var(--methyl-pale);border-left:4px solid var(--methyl);border-radius:0 10px 10px 0;padding:12px 16px;margin:12px 0;font-size:.72rem;color:var(--methyl);line-height:1.9;}
  .highlight-box.blue{background:#e8f8ff;border-color:#0090c8;color:#004080;}
  .highlight-box.green{background:#f0fdf6;border-color:var(--success);color:#0a5a30;}
  .stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:14px 0;}
  .stat-box{text-align:center;padding:10px 6px;border:1px solid var(--border);border-radius:10px;background:var(--bg);}
  .stat-box .sb-val{font-size:1.3rem;font-weight:700;color:var(--methyl);display:block;}
  .stat-box .sb-label{font-size:.52rem;color:var(--dim);margin-top:2px;display:block;line-height:1.3;}
  .tumor-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0;}
  .tumor-card{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--bg);font-size:.65rem;line-height:1.6;}
  .tumor-card .tc-name{font-weight:700;color:var(--methyl);font-size:.68rem;}
  .narr-nav{display:flex;align-items:center;justify-content:space-between;margin-top:24px;}
  .narr-dots{display:flex;gap:7px;align-items:center;}
  .narr-dot{width:8px;height:8px;border-radius:50%;background:var(--border);cursor:pointer;transition:background .2s,transform .2s;}
  .narr-dot.active{background:var(--methyl);transform:scale(1.3);}
  .btn{display:inline-block;padding:11px 28px;border:none;color:#fff;font-family:'Space Mono',monospace;font-size:.74rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;border-radius:8px;transition:all .2s;}
  .btn.purple{background:var(--methyl);box-shadow:0 4px 14px rgba(139,34,212,.3);}
  .btn.purple:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(139,34,212,.4);}
  .btn.blue{background:var(--accent);box-shadow:0 4px 14px rgba(26,122,255,.3);}
  .btn.blue:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(26,122,255,.4);}
  .btn.red{background:var(--danger);box-shadow:0 4px 14px rgba(224,32,64,.3);}
  .btn.red:hover{box-shadow:0 6px 20px rgba(224,32,64,.4);}
  .btn.ghost{background:transparent;color:var(--dim);border:1.5px solid var(--border);}
  .btn.ghost:hover{background:var(--bg);color:var(--text);}
  .btn:disabled{opacity:.5;cursor:not-allowed;transform:none !important;}

  /* TUTORIAL OVERLAY */
  .tutorial-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;display:flex;align-items:center;justify-content:center;}
  .tutorial-overlay.hidden{display:none;}
  .tutorial-box{background:var(--panel);border-radius:20px;padding:32px 36px;max-width:520px;width:92%;box-shadow:0 20px 60px rgba(0,0,0,.3);text-align:center;position:relative;}
  .tutorial-box h3{font-family:'Crimson Pro',serif;font-size:1.8rem;font-style:italic;color:var(--methyl);margin-bottom:8px;}
  .tutorial-steps{display:flex;flex-direction:column;gap:10px;margin:16px 0;text-align:left;}
  .tut-step{display:flex;align-items:flex-start;gap:12px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--bg);}
  .tut-step .ts-icon{font-size:1.8rem;flex-shrink:0;line-height:1;}
  .tut-step .ts-text{font-size:.68rem;color:var(--dim);line-height:1.7;}
  .tut-step .ts-text strong{color:var(--text);display:block;margin-bottom:1px;}
  .tut-step.good{border-color:#86efac;background:#f0fdf6;}
  .tut-step.bad{border-color:#fca5a5;background:#fff2f4;}
  .tut-step.therapy{border-color:#93c5fd;background:#eff6ff;}
  .tut-step.warn{border-color:#fbbf24;background:#fffbeb;}
  .tut-progress{display:flex;gap:6px;justify-content:center;margin-bottom:18px;}
  .tut-pip{width:28px;height:5px;border-radius:3px;background:var(--border);transition:background .2s;}
  .tut-pip.done{background:var(--methyl);}

  /* GAMEOVER */
  .gameover-modal{background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:40px;max-width:420px;width:92%;text-align:center;box-shadow:0 16px 60px rgba(26,37,64,.14);}
  .gameover-modal h1{font-family:'Crimson Pro',serif;font-size:2.5rem;font-style:italic;color:var(--danger);margin-bottom:8px;}
  .gameover-modal p{color:var(--dim);font-size:.72rem;line-height:1.9;margin-bottom:14px;}
  .score-big{font-size:2.8rem;font-weight:700;color:var(--methyl);}
  .score-label{font-size:.66rem;color:var(--dim);margin-bottom:22px;}

  /* MISC */
  .tooltip{position:fixed;background:var(--panel);border:1px solid var(--border);padding:6px 10px;border-radius:8px;font-size:.57rem;color:var(--text);pointer-events:none;z-index:50;white-space:nowrap;display:none;box-shadow:0 4px 14px rgba(26,37,64,.1);line-height:1.7;}
  #flash{position:fixed;inset:0;pointer-events:none;z-index:90;opacity:0;transition:opacity .15s;}
  #flash.red{background:rgba(224,32,64,.16);}
  #flash.green{background:rgba(24,160,96,.15);}
  #flash.blue{background:rgba(139,34,212,.12);}
</style>
</head>
<body>

<header>
  <div class="logo">Epi<span>Guard</span> â€” Methylation Defense</div>
  <div class="hud">
    <div class="stat"><div class="stat-label">Score</div><div class="stat-val" id="score-val">0</div></div>
    <div class="stat"><div class="stat-label">Level</div><div class="stat-val" id="level-val">1</div></div>
    <div class="stat">
      <div class="stat-label">Me Health</div>
      <div style="width:90px;height:10px;background:var(--border);border-radius:5px;overflow:hidden;margin-top:2px;">
        <div id="me-bar-fill" style="height:100%;width:100%;background:linear-gradient(90deg,#8b22d4,#c47ef5);border-radius:5px;transition:width .4s ease,background .4s;"></div>
      </div>
      <div style="font-size:.5rem;color:var(--dim);margin-top:2px;" id="me-bar-label">23 / 23</div>
    </div>
    <div class="miss-counter">
      <div class="stat-label">Misses</div>
      <div class="miss-pips" id="miss-pips">
        <div class="miss-pip" id="pip-0"></div>
        <div class="miss-pip" id="pip-1"></div>
        <div class="miss-pip" id="pip-2"></div>
      </div>
    </div>
    <div class="brains-wrap">
      <div class="stat-label">Integrity</div>
      <div class="brains-row" id="brains-row"></div>
    </div>
    <div class="slow-badge hidden" id="slow-badge">â„ï¸ SLOW</div>
  </div>
</header>

<main>
  <div class="side-panel">
    <div class="panel-title">Methylation</div>
    <div class="methyl-status">
      <div class="ms-label">Me marks</div>
      <div class="ms-val" id="methyl-count">â€”</div>
      <div class="ms-sub">across genome</div>
    </div>
    <div class="separator"></div>
    <div class="marks-count">Restored<br><span class="ok" id="placed-count">0</span><br>Lost<br><span class="bad" id="lost-count">0</span></div>
    <div class="separator"></div>
    <div class="legend-title">Catch âœ“</div>
    <div class="legend-item"><span class="legend-emoji">ğŸ‡</span>Blueberry â€” ğŸ§ </div>
    <div class="legend-item"><span class="legend-emoji">ğŸ¥¦</span>Broccoli â€” ğŸ§ </div>
    <div class="legend-item"><span class="legend-emoji">ğŸ§˜</span>Yoga â€” ğŸ§ </div>
    <div class="legend-item"><span class="legend-emoji">ğŸƒ</span>Running â€” ğŸ§ </div>
    <div class="legend-item"><span class="legend-emoji">ğŸ’Š</span>Drug â€” âœ¨ all Me</div>
    <div class="legend-item"><span class="legend-emoji">ğŸ§¬</span>CAR-T â€” âœ¨ all Me</div>
    <div class="legend-item"><svg width="16" height="16" viewBox="0 0 32 32" style="flex-shrink:0" title="JMJD3 protein"><circle cx="16" cy="16" r="7" fill="#8b22d4"/><circle cx="7" cy="10" r="4" fill="#c47ef5"/><circle cx="25" cy="10" r="4" fill="#c47ef5"/><circle cx="7" cy="22" r="4" fill="#c47ef5"/><circle cx="25" cy="22" r="4" fill="#c47ef5"/><line x1="11" y1="13" x2="13" y2="14" stroke="#6b10b0" stroke-width="1.5"/><line x1="21" y1="13" x2="19" y2="14" stroke="#6b10b0" stroke-width="1.5"/><line x1="11" y1="19" x2="13" y2="18" stroke="#6b10b0" stroke-width="1.5"/><line x1="21" y1="19" x2="19" y2="18" stroke="#6b10b0" stroke-width="1.5"/></svg>JMJD3 â€” âœ¨ all Me</div>
    <div class="separator"></div>
    <div class="legend-title">Avoid âœ—</div>
    <div class="legend-item"><span class="legend-emoji">â˜€ï¸</span>UV rays</div>
    <div class="legend-item"><span class="legend-emoji">ğŸ§ª</span>Chemicals</div>
    <div class="legend-item"><span class="legend-emoji">ğŸš¬</span>Tobacco</div>
    <div class="legend-item"><span class="legend-emoji">ğŸ”</span>Junk food</div>
  </div>

  <div class="game-area">
    <canvas id="chromatin-canvas"></canvas>
    <div id="items-layer"></div>
  </div>

  <div class="events-panel">
    <div class="events-title">Molecular Events</div>
    <div class="events-log" id="events-log"></div>
    <div class="tumour-meter">
      <div class="tumour-label">Tumour Risk <span id="tumour-pct">0%</span></div>
      <div class="tumour-bar"><div class="tumour-fill" id="tumour-fill" style="width:0%"></div></div>
    </div>
  </div>
</main>

<!-- â•â• NARRATIVE OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="narrative-overlay">
  <div class="narrative-modal">
    <div class="narr-header">
      <div class="narr-logo">ğŸ§¬</div>
      <div class="narr-title">EpiGuard<span>A game inspired by real science</span></div>
    </div>

    <div class="narr-slides">

      <!-- SLIDE 1: The mystery of cell identity -->
      <div class="narr-slide active" id="slide-0">
        <div class="slide-tag science">The Science</div>
        <h2>Every cell tells a different story</h2>
        <p>Your body contains <strong>over 30,000 billion cells</strong> â€” neurons, muscle cells, immune cells â€” all sharing the <strong>exact same DNA</strong>. So what makes them different?</p>
        <p>The answer lies in <strong>epigenetics</strong>: chemical tags that decorate DNA and histones, telling each gene whether to switch on or off. One of the most important tags is <strong>methylation</strong> â€” a tiny molecular flag that shapes a cell's identity and fate.</p>
        <div class="highlight-box">
          ğŸ”¬ <strong>DNA methylation</strong> acts like a dimmer switch on genes. Remove the wrong methylation marks at the wrong time, and a cell can lose its identity â€” opening the door to cancer.
        </div>
        <p>In certain pediatric brain tumors, a single mutation â€” <strong>histone H3K27M</strong> â€” disrupts the entire methylation landscape, sending developing cells off course.</p>
      </div>

      <!-- SLIDE 2: Pediatric brain cancers -->
      <div class="narr-slide" id="slide-1">
        <div class="slide-tag science">The Challenge</div>
        <h2>Brain tumors in children</h2>
        <p>Pediatric brain tumors are the <strong>second most common cancer in children under 15</strong> in France, with nearly <strong>500 new cases each year</strong>. Most arise when cell fate goes wrong during embryonic development.</p>
        <div class="tumor-grid">
          <div class="tumor-card"><div class="tc-name">ğŸ§  DMG</div>Diffuse Midline Gliomas â€” driven by epigenetic alterations, including H3K27M mutation</div>
          <div class="tumor-card"><div class="tc-name">ğŸ§  DHG</div>Hemispheric Gliomas â€” pHGG subtype with histone H3.3 mutations affecting chromatin</div>
          <div class="tumor-card"><div class="tc-name">ğŸ§  ATRT</div>Atypical Rhabdoid Teratoid Tumors â€” mutations disrupting chromatin regulation</div>
          <div class="tumor-card"><div class="tc-name">ğŸ§  MB</div>Medulloblastoma â€” same mutation can generate different tumors depending on cell of origin</div>
        </div>
        <div class="highlight-box">
          These tumors share a key feature: <strong>epigenetic disruption</strong> of chromatin â€” including loss of methylation marks â€” derails normal brain development.
        </div>
      </div>

      <!-- SLIDE 3: PEPR Cell-ID program -->
      <div class="narr-slide" id="slide-2">
        <div class="slide-tag program">The Program</div>
        <h2>PEPR Cell-ID: Intercepting cancer early</h2>
        <p>To fight these cancers, French researchers launched <strong>PEPR Cell-ID</strong> â€” the <em>Cellular Identities and Destinies</em> exploratory program, part of France 2030, co-piloted by <strong>CNRS and Inserm</strong>.</p>
        <div class="stat-row">
          <div class="stat-box"><span class="sb-val">â‚¬50M</span><span class="sb-label">Budget over 7 years</span></div>
          <div class="stat-box"><span class="sb-val">30</span><span class="sb-label">Labs across France</span></div>
          <div class="stat-box"><span class="sb-val">120+</span><span class="sb-label">Researchers</span></div>
          <div class="stat-box"><span class="sb-val">8</span><span class="sb-label">French cities</span></div>
        </div>
        <p>Led by <strong>GeneviÃ¨ve Almouzni</strong> (Institut Curie), Cell-ID coordinates labs in Paris, Lyon, Strasbourg, Toulouse, Grenoble, Montpellier, Marseille, and Valbonne â€” with partners including Institut Pasteur, Gustave Roussy, and PSL University.</p>
        <div class="highlight-box blue">
          ğŸ”— Learn more at <strong>pepr-cell-id.fr</strong> â€” the program publishes all data and tools in open access following FAIR principles, contributing to the Human Cell Atlas.
        </div>
      </div>

      <!-- SLIDE 4: What scientists do -->
      <div class="narr-slide" id="slide-3">
        <div class="slide-tag mission">The Mission</div>
        <h2>Four teams, one goal</h2>
        <p>Cell-ID is structured around four complementary projects working together toward <strong>cellular interception medicine</strong>:</p>
        <div class="tumor-grid">
          <div class="tumor-card"><div class="tc-name">ğŸ”­ Cell Context</div>Single-cell multi-omics to map each cell's identity in 3D space</div>
          <div class="tumor-card"><div class="tc-name">ğŸ§« Cell Exp</div>Brain organoids â€” 3D mini-brains grown in the lab to model tumors</div>
          <div class="tumor-card"><div class="tc-name">ğŸ¤– Data Med</div>AI tools to analyze petabyte-scale data and intercept tumors early</div>
          <div class="tumor-card"><div class="tc-name">ğŸ“ Cell Next</div>Training the next generation of interdisciplinary researchers</div>
        </div>
        <div class="highlight-box green">
          ğŸ¯ The goal: detect tumors <strong>earlier</strong>, develop <strong>epidrugs</strong> that restore methylation, and give children a better chance of recovery with fewer long-term side effects.
        </div>
      </div>

      <!-- SLIDE 5: Game intro -->
      <div class="narr-slide" id="slide-4">
        <div class="slide-tag game">Play the Game</div>
        <h2>Now it's your turn to defend the epigenome</h2>
        <p>In this game, you play as a molecular guardian protecting the chromatin of a developing brain cell. The <strong>H3K27M mutation</strong> keeps attacking â€” stripping methylation marks one by one.</p>
        <div class="highlight-box">
          <strong>Your mission:</strong> click flashing nucleosomes to restore lost methylation marks before the timer runs out. Catch helpful items falling from above â€” and avoid environmental hazards!
        </div>
        <p>Every mark you restore is one step closer to stopping a tumor. Every mark lost nudges the cell one step further toward cancer.</p>
        <p style="text-align:center;margin-top:6px;">A short tutorial will guide you through the mechanics before your first game. Ready?</p>
      </div>

    </div><!-- /narr-slides -->

    <div class="narr-nav">
      <button class="btn ghost" id="narr-prev" onclick="narrativeNav(-1)" disabled>â† Back</button>
      <div class="narr-dots" id="narr-dots"></div>
      <button class="btn purple" id="narr-next" onclick="narrativeNav(1)">Next â†’</button>
    </div>
  </div>
</div>

<!-- â•â• TUTORIAL OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tutorial-overlay hidden" id="tutorial-overlay">
  <div class="tutorial-box">
    <div class="tut-progress" id="tut-progress"></div>
    <h3 id="tut-title">How to Play</h3>
    <div class="tutorial-steps" id="tut-steps"></div>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:8px;">
      <button class="btn ghost" id="tut-prev" onclick="tutNav(-1)">â† Back</button>
      <button class="btn purple" id="tut-next" onclick="tutNav(1)">Next â†’</button>
    </div>
  </div>
</div>

<!-- â•â• GAME OVER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay hidden" id="gameover-overlay">
  <div class="gameover-modal">
    <h1>Epigenome Corrupted</h1>
    <p>Methylation has collapsed. Tumour formation is inevitable.</p>
    <div class="score-big" id="final-score">0</div>
    <div class="score-label">methylation marks restored</div>
    <div style="display:flex;gap:12px;justify-content:center;">
      <button class="btn purple" onclick="showTutorial()">Tutorial</button>
      <button class="btn red" onclick="startGame()">Restart</button>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>
<div id="flash"></div>

<script>
// â”€â”€ CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas   = document.getElementById('chromatin-canvas');
const ctx      = canvas.getContext('2d');
const gameArea = document.querySelector('.game-area');
function resizeCanvas(){canvas.width=gameArea.clientWidth;canvas.height=gameArea.clientHeight;}
resizeCanvas(); window.addEventListener('resize',resizeCanvas);

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NCOUNT   = 8;
const ME_COLOR = '#8b22d4';
const MAX_HP   = 5;
const MISSES_PER_BRAIN = 3; // lose a brain every 3 missed marks

const GOOD_FOOD=[
  {emoji:'ğŸ‡',label:'Blueberry',type:'food'},
  {emoji:'ğŸ¥¦',label:'Broccoli',type:'food'},
  {emoji:'ğŸ§˜',label:'Yoga',type:'food'},
  {emoji:'ğŸƒ',label:'Running',type:'food'},
  {emoji:'ğŸ¥—',label:'Salad',type:'food'},
  {emoji:'ğŸµ',label:'Green Tea',type:'food'},
];
const THERAPY=[
  {emoji:'ğŸ’Š',label:'Drug',type:'therapy'},
  {emoji:'ğŸ§¬',label:'CAR-T',type:'therapy'},
  {emoji:'ğŸ”´',label:'JMJD3',type:'therapy',isProtein:true},
];
const DANGERS=[
  {emoji:'â˜€ï¸',label:'UV Rays',type:'danger'},
  {emoji:'ğŸ§ª',label:'Chemical',type:'danger'},
  {emoji:'ğŸš¬',label:'Tobacco',type:'danger'},
  {emoji:'ğŸ”',label:'Junk Food',type:'danger'},
];

const ME_SLOTS_PER=[3,2,4,3,2,3,4,2];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let nucleosomes=[],alerts=[],particles=[],fallingItems=[];
let score=0,hp=MAX_HP,missCount=0,tumourRisk=0,placedCount=0,lostCount=0,level=1;
let gameActive=false;
let eventInterval=null,tickInterval=null,itemSpawnInterval=null,animFrame=null;
let time=0;

// â”€â”€ NARRATIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let narrativeSlide=0;
const N_SLIDES=5;

function buildNarrDots(){
  const c=document.getElementById('narr-dots');
  c.innerHTML='';
  for(let i=0;i<N_SLIDES;i++){
    const d=document.createElement('div');
    d.className='narr-dot'+(i===0?' active':'');
    d.onclick=()=>goToSlide(i);
    c.appendChild(d);
  }
}
function goToSlide(i){
  document.getElementById(`slide-${narrativeSlide}`).classList.remove('active');
  narrativeSlide=i;
  document.getElementById(`slide-${narrativeSlide}`).classList.add('active');
  document.querySelectorAll('.narr-dot').forEach((d,j)=>d.classList.toggle('active',j===narrativeSlide));
  document.getElementById('narr-prev').disabled=narrativeSlide===0;
  const nextBtn=document.getElementById('narr-next');
  if(narrativeSlide===N_SLIDES-1){nextBtn.textContent='Play â†’';nextBtn.onclick=()=>showTutorial();}
  else{nextBtn.textContent='Next â†’';nextBtn.onclick=()=>narrativeNav(1);}
}
function narrativeNav(dir){goToSlide(Math.max(0,Math.min(N_SLIDES-1,narrativeSlide+dir)));}
buildNarrDots();

// â”€â”€ TUTORIAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TUT_STEPS=[
  {
    title:'ğŸ§¬ Defend the Chromatin',
    steps:[
      {icon:'ğŸ§«',cls:'',text:'<strong>The nucleosomes</strong> are the round structures on the DNA strand. Each one carries several purple Methylation (Me) dots â€” these are the marks you must protect.'},
      {icon:'â“',cls:'warn',text:'<strong>When a mark is stripped</strong> by the H3K27M mutation, it flashes and shows a countdown ring. You have limited time to restore it!'},
      {icon:'ğŸ‘†',cls:'',text:'<strong>Click any flashing nucleosome</strong> to restore the missing methylation mark. The closer to center the better, but any click on the nucleosome body works.'},
    ]
  },
  {
    title:'ğŸ§  Your Health Points',
    steps:[
      {icon:'ğŸ§ ',cls:'warn',text:'<strong>You have 5 brain icons</strong> as health points. But you won\'t lose one immediately for each miss â€” you get 3 chances!'},
      {icon:'ğŸ”´',cls:'warn',text:'<strong>3 misses = 1 brain lost.</strong> Watch the red dots in the header â€” they fill up with each missed mark. On the third, you lose a ğŸ§ .'},
      {icon:'ğŸ’ª',cls:'good',text:'<strong>Catch good food & sport items</strong> falling from above to restore a brain point! ğŸ‡ğŸ¥¦ğŸ§˜ğŸƒ'},
    ]
  },
  {
    title:'ğŸ¯ Falling Items',
    steps:[
      {icon:'ğŸ‡',cls:'good',text:'<strong>Good food & sport</strong> (grapes/blueberries, broccoli, yoga, runningâ€¦) â€” Click to <strong>restore a ğŸ§ </strong>. These represent a healthy lifestyle protecting your epigenome!'},
      {icon:'ğŸ’Š',cls:'therapy',text:'<strong>Therapy items</strong> (Drug, CAR-T, and the <b>JMJD3 protein</b> â€” shown as a purple molecule) â€” Click to <strong>restore ALL missing methylation marks</strong> instantly! Based on real epidrugs and cellular therapies studied in Cell-ID.'},
      {icon:'â˜€ï¸',cls:'bad',text:'<strong>Environmental dangers</strong> (UV, chemicals, tobacco, junk food) â€” <strong>DO NOT click!</strong> They cause extra demethylation on multiple nucleosomes at once.'},
    ]
  },
  {
    title:'ğŸ“ˆ Progression & Tips',
    steps:[
      {icon:'â¬†ï¸',cls:'warn',text:'<strong>Difficulty scales with methylation loss.</strong> As more marks are stripped, the mutation rate automatically ramps up. Lose all marks and it\'s instant game over â€” the epigenome collapses!'},
      {icon:'ğŸ’¡',cls:'good',text:'<strong>Tip:</strong> Prioritize nucleosomes with the most missing marks (N3 and N7 have 4 slots each!). A single danger click can strip 2â€“3 marks at once.'},
      {icon:'ğŸ“',cls:'therapy',text:'<strong>Science note:</strong> This game is inspired by the PEPR Cell-ID program â€” 30 French labs, â‚¬50M budget, studying pediatric brain cancers. <em>pepr-cell-id.fr</em>'},
    ]
  },
];
let tutPage=0;

function showTutorial(){
  document.getElementById('narrative-overlay').classList.add('hidden');
  document.getElementById('gameover-overlay').classList.add('hidden');
  tutPage=0;
  renderTutPage();
  document.getElementById('tutorial-overlay').classList.remove('hidden');
}
function renderTutPage(){
  const step=TUT_STEPS[tutPage];
  document.getElementById('tut-title').textContent=step.title;
  const stepsEl=document.getElementById('tut-steps');
  stepsEl.innerHTML='';
  step.steps.forEach(s=>{
    const div=document.createElement('div');
    div.className='tut-step '+(s.cls||'');
    div.innerHTML=`<div class="ts-icon">${s.icon}</div><div class="ts-text">${s.text}</div>`;
    stepsEl.appendChild(div);
  });
  const prog=document.getElementById('tut-progress');
  prog.innerHTML='';
  TUT_STEPS.forEach((_,i)=>{
    const p=document.createElement('div');
    p.className='tut-pip'+(i<=tutPage?' done':'');
    prog.appendChild(p);
  });
  document.getElementById('tut-prev').disabled=tutPage===0;
  const nextBtn=document.getElementById('tut-next');
  if(tutPage===TUT_STEPS.length-1){nextBtn.textContent='Start Game!';nextBtn.onclick=()=>{document.getElementById('tutorial-overlay').classList.add('hidden');startGame();};}
  else{nextBtn.textContent='Next â†’';nextBtn.onclick=()=>tutNav(1);}
}
function tutNav(dir){
  tutPage=Math.max(0,Math.min(TUT_STEPS.length-1,tutPage+dir));
  renderTutPage();
}

// â”€â”€ BRAINS + MISS COUNTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBrains(){
  const row=document.getElementById('brains-row');
  row.innerHTML='';
  for(let i=0;i<MAX_HP;i++){
    const s=document.createElement('span');
    s.className='brain-icon'+(i>=hp?' lost':'');
    s.id=`brain-${i}`;s.textContent='ğŸ§ ';
    row.appendChild(s);
  }
}
function renderMissPips(){
  for(let i=0;i<MISSES_PER_BRAIN;i++){
    const pip=document.getElementById(`pip-${i}`);
    if(pip) pip.classList.toggle('filled',i<missCount);
  }
}
function shakeAndLoseBrain(){
  const el=document.getElementById(`brain-${hp}`);
  if(el){el.classList.add('shake');setTimeout(()=>{el.classList.remove('shake');el.classList.add('lost');},420);}
}
function gainBrain(){
  if(hp>=MAX_HP) return false;
  hp++;
  renderBrains();
  const el=document.getElementById(`brain-${hp-1}`);
  if(el){el.classList.remove('lost');el.classList.add('gain');setTimeout(()=>el.classList.remove('gain'),500);}
  return true;
}

// â”€â”€ FLASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flash(color){
  const el=document.getElementById('flash');
  el.className=color;el.style.opacity='1';
  setTimeout(()=>{el.style.opacity='0';setTimeout(()=>el.className='',200);},160);
}

// â”€â”€ NUCLEOSOMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initNucleosomes(){
  nucleosomes=[];
  const W=canvas.width,H=canvas.height;
  const spacing=(W-100)/(NCOUNT-1);
  for(let i=0;i<NCOUNT;i++){
    const slots=ME_SLOTS_PER[i];
    nucleosomes.push({x:50+i*spacing,y:H*.68+Math.sin(i*.9)*46,r:38,meSlots:new Array(slots).fill(true)});
  }
  alerts=[];
}
function countTotalMe(){return nucleosomes.reduce((s,n)=>s+n.meSlots.filter(Boolean).length,0);}

function getMeDotPositions(total,r){
  const sep=16,pos=[];
  if(total===2){pos.push({dx:-sep*.5,dy:r*.3},{dx:sep*.5,dy:r*.3});}
  else if(total===3){pos.push({dx:-sep,dy:r*.35},{dx:0,dy:r*.2},{dx:sep,dy:r*.35});}
  else if(total===4){pos.push({dx:-sep*.8,dy:r*.15},{dx:sep*.8,dy:r*.15},{dx:-sep*.3,dy:r*.42},{dx:sep*.3,dy:r*.42});}
  return pos;
}

// â”€â”€ DRAW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawDnaStrand(){
  ctx.save();
  for(let s=0;s<2;s++){
    ctx.beginPath();ctx.strokeStyle=s?'#bcd0f0':'#a8c0e8';ctx.lineWidth=s?2:3;
    ctx.shadowColor='#4080d0';ctx.shadowBlur=4;const off=s?7:-7;
    nucleosomes.forEach((n,i)=>{
      const px=n.x+Math.cos(i*1.2+s)*4,py=n.y+off;
      if(i===0){ctx.moveTo(px,py);return;}
      const pv=nucleosomes[i-1],ppx=pv.x+Math.cos((i-1)*1.2+s)*4,ppy=pv.y+off,cx=(ppx+px)/2;
      ctx.bezierCurveTo(cx,ppy+off*.4,cx,py+off*.4,px,py);
    });
    ctx.stroke();
  }
  ctx.restore();
}

function drawNucleosome(n,idx){
  const{x,y,r,meSlots}=n;ctx.save();
  const nAlerts=alerts.filter(a=>a.nucleoIdx===idx);
  const isAlert=nAlerts.length>0;
  const pulse=Math.sin(time*7)*.5+.5;
  if(isAlert){ctx.shadowColor=`rgba(224,32,64,${.22+pulse*.35})`;ctx.shadowBlur=18+pulse*12;}
  else{ctx.shadowColor='rgba(100,150,220,.08)';ctx.shadowBlur=6;}
  const g=ctx.createRadialGradient(x-r*.3,y-r*.3,r*.05,x,y,r);
  g.addColorStop(0,isAlert?'#ffe8ec':'#ddeaff');g.addColorStop(1,isAlert?'#ffd0d8':'#c0d4f5');
  ctx.fillStyle=g;ctx.beginPath();
  ctx.arc(x,y,r+(isAlert?Math.sin(time*6)*2:Math.sin(time*2+idx)*.7),0,Math.PI*2);
  ctx.fill();ctx.shadowBlur=0;
  ctx.strokeStyle=isAlert?`rgba(224,32,64,${.5+pulse*.4})`:'#8aacdc';ctx.lineWidth=isAlert?2.5:1.5;ctx.stroke();
  for(let b=-2;b<=2;b++){ctx.beginPath();ctx.strokeStyle='rgba(60,100,180,.12)';ctx.lineWidth=1;ctx.arc(x,y,r*.82,b*.38-.12,b*.38+.12+Math.PI);ctx.stroke();}
  // permanent marks
  drawPermMark(x-r*.52,y-r*.52,'#b07800','Ac');
  drawPermMark(x+r*.52,y-r*.52,'#0070aa','Ph');
  // methylation dots
  const dotPos=getMeDotPositions(meSlots.length,r);
  meSlots.forEach((present,si)=>{
    const{dx,dy}=dotPos[si],mx=x+dx,my=y+dy;
    const slotAlert=alerts.find(a=>a.nucleoIdx===idx&&a.slotIdx===si);
    if(present){
      ctx.shadowColor=ME_COLOR;ctx.shadowBlur=7;
      ctx.beginPath();ctx.arc(mx,my,7,0,Math.PI*2);ctx.fillStyle=ME_COLOR;ctx.fill();ctx.shadowBlur=0;
      ctx.fillStyle='#fff';ctx.font='bold 5.5px Space Mono';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText('Me',mx,my);ctx.textBaseline='alphabetic';
    } else if(slotAlert){
      const frac=slotAlert.timer/slotAlert.maxTimer,blink=Math.sin(time*5)>0;
      ctx.beginPath();ctx.arc(mx,my,10,0,Math.PI*2);ctx.strokeStyle='rgba(139,34,212,.14)';ctx.lineWidth=1.5;ctx.stroke();
      ctx.beginPath();ctx.arc(mx,my,10,-Math.PI/2,-Math.PI/2+frac*Math.PI*2);ctx.strokeStyle=ME_COLOR;ctx.lineWidth=2;ctx.stroke();
      if(blink){ctx.beginPath();ctx.arc(mx,my,7,0,Math.PI*2);ctx.strokeStyle=ME_COLOR;ctx.lineWidth=1.5;ctx.setLineDash([3,2]);ctx.stroke();ctx.setLineDash([]);}
      ctx.fillStyle=ME_COLOR;ctx.font='bold 8px Space Mono';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('?',mx,my);ctx.textBaseline='alphabetic';
    }
  });
  ctx.fillStyle='rgba(26,37,64,.28)';ctx.font='8px Space Mono';ctx.textAlign='center';ctx.fillText(`N${idx+1}`,x,y+r+14);
  ctx.restore();
}
function drawPermMark(mx,my,color,label){
  ctx.shadowColor=color;ctx.shadowBlur=4;
  ctx.beginPath();ctx.arc(mx,my,8,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();ctx.shadowBlur=0;
  ctx.fillStyle='rgba(255,255,255,.85)';ctx.font='bold 5px Space Mono';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(label,mx,my);ctx.textBaseline='alphabetic';
}
function drawParticles(){
  particles=particles.filter(p=>p.life>0);
  particles.forEach(p=>{
    ctx.save();ctx.globalAlpha=p.life/p.maxLife;ctx.fillStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=4;
    ctx.beginPath();ctx.arc(p.x,p.y,p.r*(p.life/p.maxLife),0,Math.PI*2);ctx.fill();ctx.restore();
    p.x+=p.vx;p.y+=p.vy;p.vy+=.05;p.life--;
  });
}
function spawnParticles(x,y,color,n=10){
  for(let i=0;i<n;i++){
    const a=(i/n)*Math.PI*2+Math.random()*.4,spd=1.1+Math.random()*2.5;
    particles.push({x,y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd-1,color,r:3+Math.random()*3,life:26+Math.random()*16,maxLife:42});
  }
}
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#eef2fa';ctx.fillRect(0,0,canvas.width,canvas.height);
  const cg=ctx.createRadialGradient(canvas.width/2,canvas.height/2,0,canvas.width/2,canvas.height/2,canvas.width*.45);
  cg.addColorStop(0,'rgba(180,210,255,.14)');cg.addColorStop(1,'transparent');
  ctx.fillStyle=cg;ctx.fillRect(0,0,canvas.width,canvas.height);
  drawDnaStrand();nucleosomes.forEach((n,i)=>drawNucleosome(n,i));drawParticles();
  time+=.016;
  document.getElementById('methyl-count').textContent=countTotalMe();
  // Update Me bar every second roughly
  if(Math.floor(time*60)%60===0) updateDynamicLevel();
  if(gameActive) animFrame=requestAnimationFrame(draw);
}

// â”€â”€ EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerRandomEvent(){
  if(!gameActive) return;
  const available=[];
  nucleosomes.forEach((n,i)=>n.meSlots.forEach((present,si)=>{
    if(present&&!alerts.find(a=>a.nucleoIdx===i&&a.slotIdx===si)) available.push({i,si});
  }));
  if(!available.length) return;
  const pick=available[Math.floor(Math.random()*available.length)];
  nucleosomes[pick.i].meSlots[pick.si]=false;
  const timeout=Math.max(4500,11000-level*650);
  alerts.push({nucleoIdx:pick.i,slotIdx:pick.si,timer:timeout/100,maxTimer:timeout/100});
  logEvent(`âš  N${pick.i+1}: Methylation slot ${pick.si+1} stripped!`,'loss');
}

// â”€â”€ DYNAMIC LEVEL based on Me count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Total possible Me marks = sum of ME_SLOTS_PER = 23
const TOTAL_ME_MAX = ME_SLOTS_PER.reduce((a,b)=>a+b,0); // 23

function updateDynamicLevel(){
  if(!gameActive) return;
  const totalMe=countTotalMe();
  const fraction=totalMe/TOTAL_ME_MAX;
  const newLevel=Math.max(1,Math.min(10,Math.floor((1-fraction)*10)+1));

  // Update Me health bar
  const fill=document.getElementById('me-bar-fill');
  const lbl=document.getElementById('me-bar-label');
  if(fill){
    fill.style.width=(fraction*100)+'%';
    // Color shifts from purple â†’ orange â†’ red as marks are lost
    if(fraction>0.6) fill.style.background='linear-gradient(90deg,#8b22d4,#c47ef5)';
    else if(fraction>0.3) fill.style.background='linear-gradient(90deg,#e07010,#fbbf24)';
    else fill.style.background='linear-gradient(90deg,#e02040,#ff6080)';
  }
  if(lbl) lbl.textContent=totalMe+' / '+TOTAL_ME_MAX;

  if(newLevel>level){
    level=newLevel;
    document.getElementById('level-val').textContent=level;
    clearInterval(eventInterval);
    eventInterval=setInterval(triggerRandomEvent,getEventRate());
    logEvent(`âš¡ Level ${level} â€” ${totalMe} marks left, mutations accelerating!`,'warn');
  }
  if(totalMe===0){
    logEvent('ğŸ’€ All methylation marks lost! Epigenome collapsed!','loss');
    endGame();
  }
}

function tickAlerts(){
  if(!gameActive) return;
  alerts=alerts.filter(a=>{
    a.timer--;
    if(a.timer<=0){
      lostCount++;
      tumourRisk=Math.min(100,tumourRisk+12+level*2);
      missCount++;
      renderMissPips();
      if(missCount>=MISSES_PER_BRAIN){
        missCount=0;renderMissPips();
        hp=Math.max(0,hp-1);
        shakeAndLoseBrain();
        logEvent(`âœ— 3 misses! ğŸ§  âˆ’1 brain lost!`,'warn');
        if(hp<=0){endGame();return false;}
      } else {
        logEvent(`âœ— N${a.nucleoIdx+1}: Methylation lost! (miss ${missCount}/${MISSES_PER_BRAIN})`,'warn');
      }
      updateDynamicLevel();
      updateHUD();return false;
    }
    return true;
  });
}

// â”€â”€ FALLING ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnFallingItem(){
  if(!gameActive) return;
  const layer=document.getElementById('items-layer');
  const W=layer.clientWidth;
  const rand=Math.random();
  let def;
  if(rand<.40) def=GOOD_FOOD[Math.floor(Math.random()*GOOD_FOOD.length)];
  else if(rand<.60) def=THERAPY[Math.floor(Math.random()*THERAPY.length)];
  else def=DANGERS[Math.floor(Math.random()*DANGERS.length)];

  const isFood=def.type==='food', isTherapy=def.type==='therapy', isDanger=def.type==='danger';
  const el=document.createElement('div');
  el.className='falling-item '+(isDanger?'danger-item':'bonus');
  el.style.left=(18+Math.random()*(W-70))+'px';
  el.style.top='-80px';

  if(def.isProtein){
    // JMJD3: render as cute SVG protein blob
    const svgEl=document.createElement('div');
    svgEl.innerHTML=`<svg width="54" height="54" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
      <!-- central domain -->
      <ellipse cx="32" cy="32" rx="14" ry="11" fill="#8b22d4"/>
      <!-- lobes / subdomains -->
      <circle cx="14" cy="22" r="8" fill="#c47ef5"/>
      <circle cx="50" cy="22" r="8" fill="#c47ef5"/>
      <circle cx="14" cy="42" r="8" fill="#c47ef5"/>
      <circle cx="50" cy="42" r="8" fill="#c47ef5"/>
      <circle cx="32" cy="11" r="6" fill="#a855f7"/>
      <circle cx="32" cy="53" r="6" fill="#a855f7"/>
      <!-- connectors -->
      <line x1="22" y1="26" x2="28" y2="28" stroke="#6b10b0" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="42" y1="26" x2="36" y2="28" stroke="#6b10b0" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="22" y1="38" x2="28" y2="36" stroke="#6b10b0" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="42" y1="38" x2="36" y2="36" stroke="#6b10b0" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="32" y1="17" x2="32" y2="22" stroke="#6b10b0" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="32" y1="47" x2="32" y2="42" stroke="#6b10b0" stroke-width="2.5" stroke-linecap="round"/>
      <!-- cute face on central domain -->
      <circle cx="28" cy="30" r="2" fill="white" opacity="0.9"/>
      <circle cx="36" cy="30" r="2" fill="white" opacity="0.9"/>
      <path d="M28 35 Q32 38 36 35" stroke="white" stroke-width="1.5" fill="none" stroke-linecap="round"/>
    </svg>`;
    el.appendChild(svgEl);
  } else {
    const emojiEl=document.createElement('span');
    emojiEl.textContent=def.emoji;
    el.appendChild(emojiEl);
  }

  const lbl=document.createElement('div');
  lbl.className='item-label '+(isFood?'good':isTherapy?'therapy':'bad');
  lbl.textContent=def.label;
  el.appendChild(lbl);

  const baseSpd=.5+level*.1+(isDanger?.08:0);
  let posY=-80;
  const obj={el,def,posY,speed:baseSpd,alive:true};
  el.addEventListener('click',e=>{e.stopPropagation();handleItemClick(obj);});
  layer.appendChild(el);fallingItems.push(obj);

  (function fall(){
    if(!obj.alive) return;
    obj.posY+=obj.speed;
    el.style.top=obj.posY+'px';
    if(obj.posY>layer.clientHeight+30){removeItem(obj);return;}
    requestAnimationFrame(fall);
  })();
}
function removeItem(obj){
  if(!obj.alive) return;
  obj.alive=false;obj.el.remove();
  fallingItems=fallingItems.filter(f=>f!==obj);
}
function handleItemClick(obj){
  if(!gameActive||!obj.alive) return;
  const{def}=obj;
  const rect=obj.el.getBoundingClientRect(),gRect=gameArea.getBoundingClientRect();
  const cx=rect.left+rect.width/2-gRect.left,cy=rect.top+rect.height/2-gRect.top;
  removeItem(obj);
  if(def.type==='food'){
    const got=gainBrain();
    flash('green');
    logEvent(got?`ğŸ‡ ${def.label}: +1 ğŸ§  health restored!`:`ğŸ‡ ${def.label}: Already full health! +1 score`,'gain');
    tumourRisk=Math.max(0,tumourRisk-6);score++;
    spawnParticles(cx,cy,'#18a060',10);updateHUD();
  } else if(def.type==='therapy'){
    // Restore ALL missing methylation marks instantly
    let restored=0;
    alerts=[]; // clear all pending alerts
    nucleosomes.forEach((n,ni)=>{
      n.meSlots.forEach((present,si)=>{
        if(!present){
          n.meSlots[si]=true;
          spawnParticles(n.x,n.y,ME_COLOR,8);
          restored++;
        }
      });
    });
    flash('blue');
    logEvent(`âœ¨ ${def.label}: All ${restored} methylation mark(s) restored!`,'gain');
    tumourRisk=Math.max(0,tumourRisk-20);
    score+=restored;placedCount+=restored;
    spawnParticles(cx,cy,'#8b22d4',16);
    updateHUD();updateDynamicLevel();
  } else {
    flash('red');
    let removed=0;
    for(let attempt=0;attempt<40&&removed<3;attempt++){
      const ni=Math.floor(Math.random()*nucleosomes.length),n=nucleosomes[ni];
      const presentSlots=n.meSlots.map((v,si)=>({v,si})).filter(({v,si})=>v&&!alerts.find(a=>a.nucleoIdx===ni&&a.slotIdx===si));
      if(presentSlots.length){
        const pick=presentSlots[Math.floor(Math.random()*presentSlots.length)];
        n.meSlots[pick.si]=false;
        const timeout=Math.max(4500,11000-level*650);
        alerts.push({nucleoIdx:ni,slotIdx:pick.si,timer:timeout/100,maxTimer:timeout/100});
        removed++;
      }
    }
    tumourRisk=Math.min(100,tumourRisk+10);
    logEvent(`â˜  ${def.label}: ${removed} methylation(s) stripped!`,'loss');
    spawnParticles(cx,cy,'#e02040',12);
    updateDynamicLevel();
    updateHUD();
  }
}


// â”€â”€ CANVAS CLICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
canvas.addEventListener('click',e=>{
  if(!gameActive) return;
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(canvas.width/rect.width);
  const my=(e.clientY-rect.top)*(canvas.height/rect.height);
  let hit=false;
  nucleosomes.forEach((n,i)=>{
    if(hit) return;
    const dx=mx-n.x,dy=my-n.y;
    if(dx*dx+dy*dy<n.r*n.r*1.4){
      const missing=alerts.filter(a=>a.nucleoIdx===i);
      if(missing.length){
        const a=missing[0],ai=alerts.indexOf(a);
        alerts.splice(ai,1);n.meSlots[a.slotIdx]=true;
        score++;placedCount++;
        spawnParticles(n.x,n.y,ME_COLOR,12);
        logEvent(`âœ“ N${i+1}: Methylation restored!`,'gain');
        tumourRisk=Math.max(0,tumourRisk-4);flash('blue');
        updateDynamicLevel();
        updateHUD();hit=true;
      }
    }
  });
});

// â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHUD(){
  document.getElementById('score-val').textContent=score;
  document.getElementById('placed-count').textContent=placedCount;
  document.getElementById('lost-count').textContent=lostCount;
  document.getElementById('tumour-pct').textContent=Math.round(tumourRisk)+'%';
  document.getElementById('tumour-fill').style.width=tumourRisk+'%';
}
function logEvent(msg,type='info'){
  const log=document.getElementById('events-log');
  const item=document.createElement('div');
  item.className='event-item '+type;item.textContent=msg;
  log.prepend(item);while(log.children.length>22) log.removeChild(log.lastChild);
}
function clearLog(){document.getElementById('events-log').innerHTML='';}

// â”€â”€ GAME LIFECYCLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(){
  score=0;hp=MAX_HP;missCount=0;tumourRisk=0;placedCount=0;lostCount=0;level=1;
  gameActive=true;time=0;particles=[];alerts=[];
  document.getElementById('slow-badge').classList.remove('active');
  fallingItems.forEach(f=>{f.alive=false;f.el.remove();});fallingItems=[];
  document.getElementById('narrative-overlay').classList.add('hidden');
  document.getElementById('gameover-overlay').classList.add('hidden');
  document.getElementById('tutorial-overlay').classList.add('hidden');
  resizeCanvas();initNucleosomes();renderBrains();renderMissPips();updateHUD();clearLog();
  // Init Me bar
  const fill=document.getElementById('me-bar-fill');
  const lbl=document.getElementById('me-bar-label');
  if(fill){fill.style.width='100%';fill.style.background='linear-gradient(90deg,#8b22d4,#c47ef5)';}
  if(lbl) lbl.textContent=TOTAL_ME_MAX+' / '+TOTAL_ME_MAX;
  logEvent('Methylation monitoring activeâ€¦','info');
  [eventInterval,tickInterval,itemSpawnInterval].forEach(id=>{if(id)clearInterval(id);});
  eventInterval    =setInterval(triggerRandomEvent,getEventRate());
  tickInterval     =setInterval(tickAlerts,100);
  itemSpawnInterval=setInterval(spawnFallingItem,getItemRate());
  setInterval(()=>{
    if(!gameActive) return;
    const newLevel=level+1;
    level=newLevel;
    document.getElementById('level-val').textContent=level;
    clearInterval(eventInterval);
    eventInterval=setInterval(triggerRandomEvent,getEventRate());
    logEvent(`âš¡ Level ${level} â€” mutation rate increasing!`,'warn');
  },15000);
  if(animFrame) cancelAnimationFrame(animFrame);
  draw();
}
function getEventRate(){return Math.max(600,3500-level*320);}
function getItemRate(){return Math.max(3800,7500-level*200);}
function endGame(){
  gameActive=false;
  [eventInterval,tickInterval,itemSpawnInterval].forEach(id=>clearInterval(id));
  fallingItems.forEach(f=>f.alive=false);
  document.getElementById('final-score').textContent=score;
  document.getElementById('gameover-overlay').classList.remove('hidden');
}

// â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
canvas.addEventListener('mousemove',e=>{
  if(!gameActive) return;
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(canvas.width/rect.width),my=(e.clientY-rect.top)*(canvas.height/rect.height);
  const tip=document.getElementById('tooltip');let found=false;
  nucleosomes.forEach((n,i)=>{
    const dx=mx-n.x,dy=my-n.y;
    if(dx*dx+dy*dy<n.r*n.r*1.3){
      const total=n.meSlots.length,present=n.meSlots.filter(Boolean).length,missing=total-present;
      tip.style.display='block';tip.style.left=(e.clientX+14)+'px';tip.style.top=(e.clientY-10)+'px';
      tip.innerHTML=`<strong>Nucleosome ${i+1}</strong><br><span style="color:${ME_COLOR}">Methylation: ${present}/${total}</span>`+(missing?`<br><span style="color:var(--danger)">${missing} slot(s) missing!</span>`:'<br><span style="color:var(--success)">All intact âœ“</span>');
      found=true;
    }
  });
  if(!found) tip.style.display='none';
});
canvas.addEventListener('mouseleave',()=>{document.getElementById('tooltip').style.display='none';});
</script>
</body>
</html>
